<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nazmus Sakib | Elite Portfolio</title>
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Hind+Siliguri:wght@400;600&family=Special+Elite&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #05070a; --card-bg: rgba(255, 255, 255, 0.05);
            --primary: #00d2ff; --text-main: #ffffff; --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.1); --glow: rgba(0, 210, 255, 0.2);
        }

        body.theme-excellent { --bg-color: #0a0904; --primary: #d4af37; --glow: rgba(212, 175, 55, 0.2); }
        body.theme-good { --bg-color: #040a0a; --primary: #00f2fe; --glow: rgba(0, 242, 254, 0.2); }
        body.theme-bad { --bg-color: #0d0d0d; --primary: #e2e8f0; --glow: rgba(255, 255, 255, 0.05); }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Outfit', 'Hind Siliguri', sans-serif; background-color: var(--bg-color); color: var(--text-main); transition: 0.5s; overflow-x: hidden; }

        .hero-section { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
        .main-container { width: 100%; max-width: 600px; }

        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(25px); border-radius: 25px;
            padding: 25px; border: 1px solid var(--border); margin-bottom: 25px; text-align: center;
        }

        .profile-img { 
            width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--primary); 
            padding: 5px; margin-bottom: 15px; box-shadow: 0 0 20px var(--glow); object-fit: cover;
        }

        h3 { font-size: 18px; margin-bottom: 15px; color: var(--primary); border-left: 4px solid var(--primary); padding-left: 12px; text-align: left;}

        input, textarea, select { 
            width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); 
            border-radius: 12px; color: white; margin-bottom: 10px; font-size: 14px; font-family: inherit;
        }

        .submit-btn { 
            width: 100%; padding: 14px; background: var(--primary); border: none; 
            border-radius: 12px; color: #000; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: 0.3s;
        }

        /* --- If You're Lost Section --- */
        .lost-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .lost-btn {
            background: transparent; border: 1px solid var(--primary); color: var(--primary);
            padding: 8px 20px; border-radius: 30px; font-size: 12px; cursor: pointer;
            transition: 0.3s; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
        }
        .lost-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--glow); }
        .lost-btn.pulse { animation: pulseGlow 2s infinite; }
        
        #comfortMsg { 
            display: none; margin-top: 15px; font-size: 15px; font-weight: 300;
            color: var(--primary); font-style: italic; animation: slideUp 0.5s ease;
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0px var(--primary); }
            50% { box-shadow: 0 0 15px var(--primary); }
            100% { box-shadow: 0 0 0px var(--primary); }
        }

        /* --- Improved Book Section --- */
        .book-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 10px; text-align: left;}
        .book-card { 
            background: rgba(255, 255, 255, 0.03); border-radius: 15px; padding: 15px; 
            border: 1px solid var(--border); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between;
        }
        .book-card:hover { border-color: var(--primary); transform: translateY(-3px); background: rgba(255,255,255,0.06); }
        .book-title { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 4px; line-height: 1.3; }
        .book-author { font-size: 11px; color: var(--text-dim); margin-bottom: 10px; }
        .read-btn { 
            display: block; padding: 8px; border: 1px solid var(--primary); color: var(--primary); 
            text-align: center; border-radius: 8px; text-decoration: none; font-size: 11px; font-weight: 600; transition: 0.3s;
        }
        .read-btn:hover { background: var(--primary); color: #000; }
        #loadMoreBtn { margin-top: 20px; background: transparent; color: var(--primary); border: 1px solid var(--primary); padding: 10px 25px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.3s;}
        #loadMoreBtn:hover { background: var(--primary); color: #000; }

        /* Utility System */
        .tool-nav { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .tool-nav-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-dim); padding: 10px 5px; border-radius: 12px; cursor: pointer; font-size: 11px; }
        .tool-nav-btn.active { background: var(--primary); color: #000; font-weight: bold;}
        .tool-content { display: none; text-align: left; background: rgba(0,0,0,0.2); padding: 18px; border-radius: 18px; }
        .tool-content.active { display: block; animation: slideUp 0.3s ease; }
        .res-box { margin-top: 15px; padding: 10px; background: rgba(0, 210, 255, 0.1); border-radius: 10px; border-left: 3px solid var(--primary); font-size: 13px; display: none; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(15px); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: #111; padding: 30px; border-radius: 20px; border: 1px solid var(--primary); width: 90%; max-width: 380px; text-align: center; }

        /* --- DIGITAL AVATAR (SPARKY) CSS --- */
        #avatar-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; align-items: flex-end;
        }

        #sparky {
            width: 50px; height: 50px; background: var(--primary); border-radius: 50%;
            cursor: pointer; position: relative; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 20px var(--primary); display: flex; align-items: center; justify-content: center;
        }
        #sparky::after { content: "‚óï‚Äø‚óï"; color: #000; font-weight: bold; font-size: 14px; }
        #sparky:hover { transform: scale(1.2) rotate(10deg); }

        #sparky-msg {
            background: white; color: black; padding: 8px 12px; border-radius: 15px;
            font-size: 12px; margin-bottom: 10px; position: relative; max-width: 150px;
            display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;
        }
        #sparky-msg::after {
            content: ""; position: absolute; bottom: -8px; right: 15px;
            border-width: 8px 8px 0; border-style: solid; border-color: white transparent;
        }

        #sparky-input-box {
            display: none; margin-bottom: 10px; animation: slideUp 0.3s ease;
        }
        #sparky-input {
            width: 120px; background: rgba(255,255,255,0.9); color: black;
            border-radius: 20px; padding: 5px 10px; font-size: 12px; border: 2px solid var(--primary);
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes dance { 0% { transform: rotate(0); } 25% { transform: rotate(20deg) scale(1.1); } 75% { transform: rotate(-20deg) scale(1.1); } 100% { transform: rotate(0); } }
        @keyframes sleep { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
        @keyframes glowPulse { 0% { box-shadow: 0 0 5px var(--primary); } 50% { box-shadow: 0 0 30px var(--primary); } 100% { box-shadow: 0 0 5px var(--primary); } }

        .anim-bounce { animation: bounce 0.6s infinite; }
        .anim-dance { animation: dance 0.5s infinite; }
        .anim-sleep { animation: sleep 3s infinite; }
        .anim-glow { animation: glowPulse 1s infinite; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body id="mainBody">

    <!-- Digital Companion (Sparky) -->
    <div id="avatar-container">
        <div id="sparky-msg">Hello! I'm Sparky.</div>
        <div id="sparky-input-box">
            <input type="text" id="sparky-input" placeholder="Type command..." onkeydown="if(event.key==='Enter') runSparkyCommand()">
        </div>
        <div id="sparky" onclick="toggleSparkyInput()" onmouseover="sparkyHover(true)" onmouseout="sparkyHover(false)"></div>
    </div>

    <div class="modal-overlay" id="moodModal">
        <div class="modal-content">
            <div id="q1">
                <h2>Welcome! üëã</h2>
                <p style="color: var(--text-dim); margin-bottom: 20px;">Choose your vibe for today</p>
                <button class="submit-btn" style="margin-bottom:10px;" onclick="applyMood('excellent')">Premium / Elite</button>
                <button class="submit-btn" style="margin-bottom:10px; background:#444; color:white;" onclick="applyMood('good')">Normal / Good</button>
                <button class="submit-btn" style="background:transparent; border:1px solid #ff4444; color:#ff4444;" onclick="applyMood('bad')">Moody / Sad</button>
            </div>
            <div id="q2" style="display: none;">
                <h3 id="moodAsk" style="border:none; text-align:center;"></h3>
                <textarea id="moodInput" rows="3" placeholder="Share your thoughts..."></textarea>
                <button class="submit-btn" onclick="closePopup()">Enter Profile</button>
            </div>
        </div>
    </div>

    <section class="hero-section">
        <div class="main-container">
            
            <!-- Profile -->
            <div class="glass-card">
                <img src="https://t.me/i/userpic/320/sakib_xragnar.jpg" alt="NZ Sakib" class="profile-img">
                <h1>Nazmus Sakib</h1>
                <p style="color:var(--text-dim); font-size: 11px; margin-top:5px;">Think Possible ‚Äî Turning Ideas into Reality.</p>
                
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                    <a href="https://facebook.com/nomore0099567" target="_blank" style="color:var(--text-dim); font-size: 20px;"><i class="fab fa-facebook"></i></a>
                    <a href="https://t.me/sakib_xragnar" target="_blank" style="color:var(--text-dim); font-size: 20px;"><i class="fab fa-telegram"></i></a>
                    <a href="https://wa.me/8801771783048" target="_blank" style="color:var(--text-dim); font-size: 20px;"><i class="fab fa-whatsapp"></i></a>
                </div>

                <div class="lost-container">
                    <button id="lostBtn" class="lost-btn" onclick="toggleLost()">If you're lost...</button>
                    <div id="comfortMsg">‚ÄúYou‚Äôre not behind. You‚Äôre just loading. ‚ú®‚Äù</div>
                </div>
            </div>

            <!-- Digital Footprint -->
            <div class="glass-card">
                <h3>Leave Your Digital Footprint</h3>
                <input type="text" id="usrName" placeholder="Your Alias (Name)">
                <textarea id="usrText" rows="3" placeholder="Drop a joke, a secret, or a memory..."></textarea>
                <button class="submit-btn" onclick="postMsg()">Post Spark</button>
                <div id="msgConfirm" style="font-size: 11px; color: #00ffaa; margin-top: 8px; display: none;">Spark sent successfully! üöÄ</div>
            </div>

            <!-- Enhanced Library -->
            <div class="glass-card">
                <h3>Elite Digital Library</h3>
                <input type="text" id="bookSearch" placeholder="Search 500+ English & Bangla Books..." oninput="searchBooks()">
                <div id="bookGrid" class="book-grid"></div>
                <button id="loadMoreBtn" onclick="loadMore()">View More Books</button>
            </div>

            <!-- Advanced Utility Hub -->
            <div class="glass-card">
                <h3>Advanced Utility Hub</h3>
                <div class="tool-nav">
                    <button class="tool-nav-btn active" onclick="openTool('ageTool', this)">Age</button>
                    <button class="tool-nav-btn" onclick="openTool('bmiTool', this)">BMI</button>
                    <button class="tool-nav-btn" onclick="openTool('unitTool', this)">Units</button>
                    <button class="tool-nav-btn" onclick="openTool('passTool', this)">Pass</button>
                    <button class="tool-nav-btn" onclick="openTool('tuneTool', this)">AutoTune</button>
                </div>

                <div id="ageTool" class="tool-content active">
                    <label style="font-size:12px; color:var(--text-dim);">Enter Date of Birth:</label>
                    <input type="date" id="birthDate" onchange="advAge()">
                    <div id="ageRes" class="res-box"></div>
                </div>

                <div id="bmiTool" class="tool-content">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="weight" placeholder="Weight (kg)">
                        <input type="number" id="height" placeholder="Height (cm)">
                    </div>
                    <button class="submit-btn" style="padding:10px;" onclick="advBMI()">Calculate BMI</button>
                    <div id="bmiRes" class="res-box"></div>
                </div>

                <div id="unitTool" class="tool-content">
                    <select id="unitType" onchange="advUnit()">
                        <option value="len">Length (KM to Miles)</option>
                        <option value="weight">Weight (KG to Pounds)</option>
                        <option value="temp">Temp (Celsius to Fahr)</option>
                    </select>
                    <input type="number" id="unitInput" placeholder="Enter value" oninput="advUnit()">
                    <div id="unitRes" class="res-box"></div>
                </div>

                <div id="passTool" class="tool-content">
                    <input type="text" id="passInput" placeholder="Type or Generate" oninput="advPass()">
                    <button class="submit-btn" style="padding:10px; font-size:11px; background:#333; color:#fff;" onclick="genPass()">Generate Secure Password</button>
                    <div id="passRes" class="res-box"></div>
                </div>

                <div id="tuneTool" class="tool-content">
                    <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">
                        üé§ Voice Analyzer / ‡¶ï‡¶£‡ßç‡¶† ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶ï  
                        <br>
                        <span style="font-size:11px;">
                            ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶ó‡¶æ‡¶® ‡¶ó‡¶æ‡¶á‡ßÅ‡¶® ‚Äî AI ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶£‡ßç‡¶† ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶¨‡ßá
                        </span>
                    </p>
                    <button class="submit-btn" onclick="startTune()">Start Voice / ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button class="submit-btn" style="margin-top:8px;background:#333;color:#fff;" onclick="stopTune()">Stop / ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <div id="tuneRes" class="res-box"></div>
                </div>
            </div>

        </div>
    </section>

    <script>
        const BOT_TOKEN = '8352894646:AAEdb1CxUL7ZyW_479SNRSiawDXY9_chHYA';
        const CHAT_ID = '7891757103';

        let audioCtx, analyser, mic, buffer, raf;
        let smoothPitch = 0;

        // --- Sparky The Companion Logic ---
        const sparky = document.getElementById('sparky');
        const sparkyMsg = document.getElementById('sparky-msg');
        const sparkyInputBox = document.getElementById('sparky-input-box');
        let currentMood = 'good';

        function sparkyHover(isHover) {
            if(isHover) {
                sparkyMsg.style.display = 'block';
                sparkyMsg.innerText = currentMood === 'bad' ? "I'm here for you..." : "Need something?";
            } else {
                if(sparkyInputBox.style.display !== 'block') sparkyMsg.style.display = 'none';
            }
        }

        function toggleSparkyInput() {
            const isVisible = sparkyInputBox.style.display === 'block';
            sparkyInputBox.style.display = isVisible ? 'none' : 'block';
            sparkyMsg.style.display = isVisible ? 'none' : 'block';
            if(!isVisible) {
                sparkyMsg.innerText = "Try: joke, dance, mood, or secret";
                document.getElementById('sparky-input').focus();
            }
        }

        function runSparkyCommand() {
            const input = document.getElementById('sparky-input');
            const cmd = input.value.toLowerCase().trim();
            input.value = "";
            sparky.className = ""; 

            if(cmd === 'joke') {
                const jokes = ["Why did the web developer walk out of a restaurant? Because of the table layout.", "Parallel lines have so much in common. It‚Äôs a shame they‚Äôll never meet.", "I'm on a whiskey diet. I've lost three days already."];
                say(jokes[Math.floor(Math.random()*jokes.length)], 'anim-bounce');
            } else if(cmd === 'dance') {
                say("I love this song! üï∫", 'anim-dance');
            } else if(cmd === 'sleep') {
                say("Zzz... Wake me up later.", 'anim-sleep');
            } else if(cmd === 'glow') {
                say("Witness my power!", 'anim-glow');
            } else if(cmd === 'mood') {
                const status = currentMood === 'excellent' ? "I feel ELITE!" : currentMood === 'bad' ? "A bit gloomy, but okay." : "I'm feeling great!";
                say(status, 'anim-bounce');
            } else if(cmd === 'secret') {
                say("Sakib is actually a coding wizard. ü§´", 'anim-glow');
            } else {
                say("I don't know that one yet!", '');
            }
        }

        function say(text, anim) {
            sparkyMsg.innerText = text;
            if(anim) sparky.classList.add(anim);
            setTimeout(() => { 
                sparky.className = ""; 
                if(currentMood === 'excellent') sparky.classList.add('anim-bounce');
                if(currentMood === 'bad') sparky.classList.add('anim-sleep');
            }, 5000);
        }

        function applyMood(m) {
            currentMood = m;
            document.body.className = 'theme-' + m;
            document.getElementById('q1').style.display='none';
            document.getElementById('q2').style.display='block';
            document.getElementById('moodAsk').innerText = m === 'bad' ? "What's wrong?" : "What's on your mind?";
            
            sparky.className = "";
            if(m === 'excellent') {
                sparky.classList.add('anim-bounce');
                say("Wow! Everything is Gold! ‚ú®", 'anim-bounce');
            } else if (m === 'bad') {
                sparky.classList.add('anim-sleep');
                document.getElementById('lostBtn').classList.add('pulse');
                say("It's okay to be sad. I'm here.", 'anim-sleep');
            } else {
                document.getElementById('lostBtn').classList.remove('pulse');
                say("Looking good today!", '');
            }
        }

        function toggleLost() {
            const msg = document.getElementById('comfortMsg');
            const btn = document.getElementById('lostBtn');
            if (msg.style.display === 'block') {
                msg.style.display = 'none';
                btn.innerText = "If you're lost...";
            } else {
                msg.style.display = 'block';
                btn.innerText = "Close Guidance";
            }
        }

        // Library Logic
        const famous = [
            {t:"Atomic Habits", a:"James Clear"}, {t:"The Alchemist", a:"Paulo Coelho"},
            {t:"‡¶π‡¶ø‡¶Æ‡ßÅ ‡¶∏‡¶Æ‡¶ó‡ßç‡¶∞", a:"‡¶π‡ßÅ‡¶Æ‡¶æ‡¶Ø‡¶º‡ßÇ‡¶® ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶"}, {t:"‡¶´‡ßá‡¶≤‡ßÅ‡¶¶‡¶æ ‡¶∏‡¶Æ‡¶ó‡ßç‡¶∞", a:"‡¶∏‡¶§‡ßç‡¶Ø‡¶ú‡¶ø‡ßé ‡¶∞‡¶æ‡¶Ø‡¶º"},
            {t:"Harry Potter", a:"J.K. Rowling"}, {t:"‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶ï‡¶¨‡¶ø‡¶§‡¶æ", a:"‡¶∞‡¶¨‡ßÄ‡¶®‡ßç‡¶¶‡ßç‡¶∞‡¶®‡¶æ‡¶• ‡¶†‡¶æ‡¶ï‡ßÅ‡¶∞"}
        ];
        let allBooks = [...famous];
        for(let i=1; i<=50; i++) { allBooks.push({t: "Classic Vol " + i, a: "Various Authors"}); }

        let limit = 6;
        function renderBooks() {
            const grid = document.getElementById('bookGrid'); grid.innerHTML = "";
            const query = document.getElementById('bookSearch').value.toLowerCase();
            const filtered = allBooks.filter(b => b.t.toLowerCase().includes(query) || b.a.toLowerCase().includes(query));
            filtered.slice(0, limit).forEach(b => {
                grid.innerHTML += `<div class="book-card"><div><p class="book-title">${b.t}</p><p class="book-author">by ${b.a}</p></div><a href="#" class="read-btn">Read Online</a></div>`;
            });
            document.getElementById('loadMoreBtn').style.display = limit >= filtered.length ? 'none' : 'inline-block';
        }
        function loadMore() { limit += 10; renderBooks(); }
        function searchBooks() { limit = 6; renderBooks(); }
        renderBooks();

        // Tool Logic
        function openTool(id, btn) {
            document.querySelectorAll('.tool-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tool-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function advAge() {
            const dob = new Date(document.getElementById('birthDate').value);
            const now = new Date();
            let years = now.getFullYear() - dob.getFullYear();
            const res = document.getElementById('ageRes');
            res.style.display = 'block'; res.innerHTML = `üìÖ <b>Age:</b> ${years} Years`;
        }

        function advBMI() {
            const w = parseFloat(document.getElementById('weight').value);
            const h = parseFloat(document.getElementById('height').value) / 100;
            if(w && h) {
                const res = document.getElementById('bmiRes');
                res.style.display = 'block'; res.innerHTML = `‚öñÔ∏è <b>BMI Score:</b> ${(w/(h*h)).toFixed(1)}`;
            }
        }

        function advUnit() {
            const val = parseFloat(document.getElementById('unitInput').value);
            const type = document.getElementById('unitType').value;
            let result = type === 'len' ? (val * 0.621).toFixed(2) + " Miles" : val;
            const res = document.getElementById('unitRes');
            res.style.display = 'block'; res.innerHTML = `üîÑ <b>Result:</b> ${result}`;
        }

        function advPass() {
            const p = document.getElementById('passInput').value;
            const res = document.getElementById('passRes');
            res.style.display = 'block'; res.innerHTML = `üîê <b>Strength:</b> ${p.length > 8 ? 'Strong' : 'Weak'}`;
        }

        function genPass() {
            const pass = Math.random().toString(36).slice(-10);
            document.getElementById('passInput').value = pass;
            advPass();
        }

        // --- NEW: AutoTune / Voice Analyzer Logic ---
        function startTune() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                mic = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                buffer = new Float32Array(analyser.fftSize);
                mic.connect(analyser);
                showTuneResult("üéß ‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø... / Listening to your voice‚Ä¶");
                listen();
            }).catch(err => showTuneResult("‚ùå Microphone access denied!"));
        }

        function stopTune() {
            if(raf) cancelAnimationFrame(raf);
            if(audioCtx) audioCtx.close();
            showTuneResult("‚èπÔ∏è ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá / Voice analysis stopped");
        }

        function listen() {
            analyser.getFloatTimeDomainData(buffer);
            const pitch = detectPitch(buffer, audioCtx.sampleRate);
            if (pitch > 0) {
                smoothPitch = smoothPitch === 0 ? pitch : smoothPitch * 0.8 + pitch * 0.2;
                const noteData = getNoteData(smoothPitch);
                const feedback = getTuneFeedback(noteData.cents);
                showTuneResult(`
                    üéº <b>Pitch:</b> ${smoothPitch.toFixed(1)} Hz<br>
                    üéπ <b>Note:</b> ${noteData.note}<br>
                    üìê <b>Tuning:</b> ${noteData.cents} cents<br>
                    üí¨ <b>Feedback:</b> ${feedback}
                `);
            }
            raf = requestAnimationFrame(listen);
        }

        function detectPitch(buf, rate) {
            let bestOffset = -1, bestCorr = 0;
            for (let offset = 20; offset < 1000; offset++) {
                let corr = 0;
                for (let i = 0; i < buf.length - offset; i++) {
                    corr += buf[i] * buf[i + offset];
                }
                if (corr > bestCorr) { bestCorr = corr; bestOffset = offset; }
            }
            return bestOffset > 0 ? rate / bestOffset : -1;
        }

        function getNoteData(freq) {
            const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            const noteNum = 12 * Math.log2(freq / 440);
            const midi = Math.round(noteNum) + 69;
            const note = notes[midi % 12];
            const cents = Math.round((noteNum - Math.round(noteNum)) * 100);
            return { note, cents };
        }

        function getTuneFeedback(cents) {
            if (Math.abs(cents) < 10) return "Perfect pitch üéØ / ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶†‡¶ø‡¶ï ‡¶∏‡ßÅ‡¶∞‡ßá ‡¶Ü‡¶õ‡ßá";
            if (cents > 0) return "Slightly sharp ‚Äî ‡¶ó‡¶≤‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¢‡¶ø‡¶≤‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®";
            return "A bit flat ‚Äî ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶ì ‡¶ú‡ßã‡¶∞ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®";
        }

        function showTuneResult(html) {
            const box = document.getElementById("tuneRes");
            box.style.display = "block"; box.innerHTML = html;
        }

        // Popup & Telegram
        window.onload = () => { setTimeout(() => { document.getElementById('moodModal').style.display='flex'; }, 1000); };
        
        function closePopup() {
            const t = document.getElementById('moodInput').value;
            if(t) fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=Mood Thought: ${t}`);
            document.getElementById('moodModal').style.display='none';
        }

        function postMsg() {
            const n = document.getElementById('usrName').value;
            const m = document.getElementById('usrText').value;
            if(n && m) {
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=By ${n}: ${m}`);
                document.getElementById('msgConfirm').style.display = 'block';
            }
        }
    </script>
</body>
</html>
